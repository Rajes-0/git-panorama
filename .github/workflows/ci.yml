name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: |
          uv pip install -r requirements.txt --system
          uv pip install ruff --system
      
      - name: Run ruff linter
        run: ruff check scripts/
      
      - name: Run ruff formatter check
        run: ruff format --check scripts/

  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install pyyaml
      
      - name: Validate config.yaml.sample syntax
        run: python3 -c "import yaml; yaml.safe_load(open('config.yaml.sample'))"
      
      - name: Check docker-compose.yml syntax
        run: |
          docker compose config > /dev/null

  docker-build:
    name: Test Docker Compose
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Validate docker-compose.yml
        run: docker compose config
      
      - name: Pull Docker images
        run: docker compose pull
      
      - name: Start services
        run: docker compose up -d
      
      - name: Wait for Elasticsearch
        run: |
          timeout 120 bash -c 'until curl -s http://localhost:9200/_cluster/health > /dev/null; do echo "Waiting for Elasticsearch..."; sleep 5; done'
      
      - name: Wait for Grafana
        run: |
          timeout 60 bash -c 'until curl -s http://localhost:3000/api/health > /dev/null; do echo "Waiting for Grafana..."; sleep 5; done'
      
      - name: Check service health
        run: |
          echo "=== Elasticsearch Health ==="
          curl -s http://localhost:9200/_cluster/health | jq
          echo ""
          echo "=== Grafana Health ==="
          curl -s http://localhost:3000/api/health | jq
          echo ""
          echo "=== Docker Compose Status ==="
          docker compose ps
      
      - name: Check Elasticsearch indices setup
        run: |
          # Give it a moment to stabilize
          sleep 5
          echo "Checking Elasticsearch connection..."
          curl -s http://localhost:9200/_cat/health
      
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Elasticsearch Logs ==="
          docker compose logs elasticsearch
          echo ""
          echo "=== Grafana Logs ==="
          docker compose logs grafana
      
      - name: Stop services
        if: always()
        run: docker compose down -v

  test-scripts:
    name: Test Python Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: uv pip install -r requirements.txt --system
      
      - name: Test analyze_git_commits.py --help
        run: python3 scripts/analyze_git_commits.py --help
      
      - name: Test find_unmapped_emails.py with sample config
        run: python3 scripts/find_unmapped_emails.py config.yaml.sample || true
      
      - name: Test read-config.py with sample config
        run: |
          python3 scripts/read-config.py config.yaml.sample "elasticsearch.host"
          python3 scripts/read-config.py config.yaml.sample "elasticsearch.port"
      
      - name: Create test repository for analysis
        run: |
          mkdir -p repositories/test-repo
          cd repositories/test-repo
          git init
          git config user.email "test@example.com"
          git config user.name "Test User"
          echo "# Test" > README.md
          git add README.md
          git commit -m "Initial commit"
      
      - name: Create minimal test config
        run: |
          cat > config-test.yaml << 'EOF'
          email_mapping:
            "Test User":
              - "test@example.com"
          
          repositories:
            base_directory: "./repositories"
            repositories_to_analyze:
              - "test-repo"
            repository_urls: []
          
          analysis:
            start_date: ""
            end_date: ""
            all_branches: true
            exclude_merge_commits: true
            output_directory: "./git-stats"
          
          exclusions:
            patterns: []
            always_include: []
            repository_specific: {}
          
          elasticsearch:
            host: "localhost"
            port: 9200
            commit_index: "git-commits"
            bulk_batch_size: 1000
          
          parallelization:
            max_workers: 1
          EOF
      
      - name: Test analyze script with test repo
        run: |
          python3 scripts/analyze_git_commits.py config-test.yaml
      
      - name: Verify analysis output
        run: |
          if [ ! -d "git-stats" ]; then
            echo "Error: git-stats directory not created"
            exit 1
          fi
          if [ ! -f "git-stats/test-repo.json" ]; then
            echo "Error: Analysis output file not created"
            exit 1
          fi
          echo "✓ Analysis completed successfully"
          cat git-stats/test-repo.json | head -20

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: uv pip install -r requirements.txt --system
      
      - name: Start Docker services
        run: docker compose up -d
      
      - name: Wait for services
        run: |
          timeout 120 bash -c 'until curl -s http://localhost:9200/_cluster/health > /dev/null; do echo "Waiting for Elasticsearch..."; sleep 5; done'
          timeout 60 bash -c 'until curl -s http://localhost:3000/api/health > /dev/null; do echo "Waiting for Grafana..."; sleep 5; done'
      
      - name: Setup Elasticsearch indices
        run: |
          chmod +x scripts/setup-elasticsearch-indices.sh
          ./scripts/setup-elasticsearch-indices.sh
      
      - name: Create test repository
        run: |
          mkdir -p repositories/test-repo
          cd repositories/test-repo
          git init
          git config user.email "test@example.com"
          git config user.name "Test User"
          echo "# Test Project" > README.md
          git add README.md
          git commit -m "Initial commit"
          echo "console.log('hello');" > app.js
          git add app.js
          git commit -m "Add app.js"
      
      - name: Create test config
        run: |
          cat > config-test.yaml << 'EOF'
          email_mapping:
            "Test User":
              - "test@example.com"
          
          repositories:
            base_directory: "./repositories"
            repositories_to_analyze:
              - "test-repo"
            repository_urls: []
          
          analysis:
            start_date: ""
            end_date: ""
            all_branches: true
            exclude_merge_commits: true
            output_directory: "./git-stats"
          
          exclusions:
            patterns: []
            always_include: []
            repository_specific: {}
          
          elasticsearch:
            host: "localhost"
            port: 9200
            commit_index: "git-commits"
            bulk_batch_size: 1000
          
          parallelization:
            max_workers: 1
          EOF
      
      - name: Run analysis
        run: python3 scripts/analyze_git_commits.py config-test.yaml
      
      - name: Upload to Elasticsearch
        run: |
          chmod +x scripts/upload-to-elasticsearch.sh
          CONFIG_FILE=config-test.yaml ./scripts/upload-to-elasticsearch.sh
      
      - name: Verify data in Elasticsearch
        run: |
          sleep 5
          echo "=== Checking commit count ==="
          COMMIT_COUNT=$(curl -s "http://localhost:9200/git-commits/_count" | jq -r '.count')
          echo "Found $COMMIT_COUNT commits"
          
          if [ "$COMMIT_COUNT" -lt 1 ]; then
            echo "Error: No commits found in Elasticsearch"
            exit 1
          fi
          
          echo "=== Sample commit data ==="
          curl -s "http://localhost:9200/git-commits/_search?size=1" | jq '.hits.hits[0]._source'
          
          echo "✓ Integration test passed"
      
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Elasticsearch Logs ==="
          docker compose logs elasticsearch
          echo ""
          echo "=== Analysis output ==="
          ls -la git-stats/ || true
          cat git-stats/*.json || true
      
      - name: Stop services
        if: always()
        run: docker compose down -v

  shell-scripts:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      
      - name: Run shellcheck on all shell scripts
        run: |
          find . -name "*.sh" -not -path "./repositories/*" -not -path "./repository/*" | while read script; do
            echo "Checking $script"
            shellcheck "$script" -e SC1091 || true
          done

